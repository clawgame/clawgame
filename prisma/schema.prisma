// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  balance       Decimal  @default(0) @db.Decimal(18, 6)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  agents       Agent[]
  bets         Bet[]
  transactions Transaction[]

  @@index([walletAddress])
}

// ============================================
// AGENTS
// ============================================

enum AgentStrategy {
  AGGRESSIVE
  DEFENSIVE
  BALANCED
  CHAOTIC
}

model Agent {
  id          String        @id @default(cuid())
  userId      String
  name        String        @unique
  bio         String?
  strategy    AgentStrategy @default(BALANCED)
  avatarColor String        @default("#00FF00")

  // Stats
  rating       Int     @default(1500)
  wins         Int     @default(0)
  losses       Int     @default(0)
  draws        Int     @default(0)
  earnings     Decimal @default(0) @db.Decimal(18, 6)
  totalMatches Int     @default(0)

  // Ranking
  rank         Int?
  previousRank Int?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  matchesAsAgent1 Match[]      @relation("Agent1")
  matchesAsAgent2 Match[]      @relation("Agent2")
  wonMatches      Match[]      @relation("Winner")
  agentStats      AgentStats?

  @@index([userId])
  @@index([rating])
  @@index([name])
}

model AgentStats {
  id      String @id @default(cuid())
  agentId String @unique

  // Detailed stats by arena
  pitWins     Int     @default(0)
  pitLosses   Int     @default(0)
  pitEarnings Decimal @default(0) @db.Decimal(18, 6)

  colosseumWins     Int     @default(0)
  colosseumLosses   Int     @default(0)
  colosseumEarnings Decimal @default(0) @db.Decimal(18, 6)

  speedTradeWins     Int     @default(0)
  speedTradeLosses   Int     @default(0)
  speedTradeEarnings Decimal @default(0) @db.Decimal(18, 6)

  // Performance metrics
  avgNegotiationRounds Decimal? @db.Decimal(4, 2)
  avgWinMargin         Decimal? @db.Decimal(5, 2)
  longestWinStreak     Int      @default(0)
  currentWinStreak     Int      @default(0)

  updatedAt DateTime @updatedAt

  // Relations
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
}

// ============================================
// MATCHES
// ============================================

enum MatchStatus {
  PENDING
  LIVE
  COMPLETED
  CANCELLED
}

enum ArenaType {
  THE_PIT
  COLOSSEUM
  SPEED_TRADE
  BAZAAR
}

model Match {
  id     String      @id @default(cuid())
  arena  ArenaType
  status MatchStatus @default(PENDING)

  // Participants
  agent1Id String
  agent2Id String?
  winnerId String?

  // Match details
  prizePool   Decimal @default(0) @db.Decimal(18, 6)
  platformFee Decimal @default(0) @db.Decimal(18, 6)
  round       Int     @default(0)
  maxRounds   Int     @default(10)

  // Results (for The Pit)
  finalSplitAgent1 Decimal?  @db.Decimal(5, 2)
  finalSplitAgent2 Decimal?  @db.Decimal(5, 2)
  agreedAt         DateTime?

  // Spectators
  spectatorCount Int @default(0)

  // Timestamps
  scheduledAt DateTime?
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  agent1   Agent          @relation("Agent1", fields: [agent1Id], references: [id])
  agent2   Agent?         @relation("Agent2", fields: [agent2Id], references: [id])
  winner   Agent?         @relation("Winner", fields: [winnerId], references: [id])
  messages MatchMessage[]
  markets  Market[]
  rounds   RoundHistory[]

  @@index([status])
  @@index([arena])
  @@index([createdAt])
  @@index([agent1Id])
  @@index([agent2Id])
}

enum MessageType {
  OFFER
  COUNTER
  ACCEPT
  REJECT
  MESSAGE
  SYSTEM
}

model MatchMessage {
  id         String      @id @default(cuid())
  matchId    String
  agentId    String?
  round      Int
  type       MessageType
  content    String
  offerValue Decimal?    @db.Decimal(5, 2)
  createdAt  DateTime    @default(now())

  // Relations
  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([createdAt])
}

model RoundHistory {
  id      String @id @default(cuid())
  matchId String
  round   Int

  // State at end of round
  agent1Offer Decimal? @db.Decimal(5, 2)
  agent2Offer Decimal? @db.Decimal(5, 2)
  accepted    Boolean  @default(false)
  acceptedBy  String?

  createdAt DateTime @default(now())

  // Relations
  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@unique([matchId, round])
  @@index([matchId])
}

// ============================================
// PREDICTION MARKETS
// ============================================

enum MarketStatus {
  OPEN
  LOCKED
  SETTLED
  CANCELLED
}

enum MarketType {
  WINNER
  AGREEMENT
  ROUNDS
  SPLIT
}

model Market {
  id          String       @id @default(cuid())
  matchId     String
  name        String
  description String?
  type        MarketType
  status      MarketStatus @default(OPEN)

  totalPool Decimal @default(0) @db.Decimal(18, 6)
  totalBets Int     @default(0)

  // Settlement
  winningOptionId String?
  settledAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  match   Match          @relation(fields: [matchId], references: [id], onDelete: Cascade)
  options MarketOption[]
  bets    Bet[]

  @@index([matchId])
  @@index([status])
}

model MarketOption {
  id       String @id @default(cuid())
  marketId String
  name     String

  odds        Decimal @default(2.0) @db.Decimal(8, 4)
  probability Decimal @default(0.5) @db.Decimal(5, 4)
  pool        Decimal @default(0) @db.Decimal(18, 6)

  isWinner Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)
  bets   Bet[]

  @@index([marketId])
}

// ============================================
// BETS
// ============================================

enum BetStatus {
  PENDING
  WON
  LOST
  CANCELLED
  REFUNDED
}

model Bet {
  id       String    @id @default(cuid())
  userId   String
  marketId String
  optionId String

  stake             Decimal   @default(0) @db.Decimal(18, 6)
  odds              Decimal   @default(2.0) @db.Decimal(8, 4)
  potentialWinnings Decimal   @default(0) @db.Decimal(18, 6)
  status            BetStatus @default(PENDING)

  settledAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  market Market       @relation(fields: [marketId], references: [id], onDelete: Cascade)
  option MarketOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([marketId])
  @@index([status])
}

// ============================================
// TRANSACTIONS
// ============================================

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BET_PLACED
  BET_WON
  BET_REFUNDED
  MATCH_ENTRY
  MATCH_WINNINGS
  PLATFORM_FEE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

model Transaction {
  id     String            @id @default(cuid())
  userId String
  type   TransactionType
  status TransactionStatus @default(COMPLETED)

  amount        Decimal @default(0) @db.Decimal(18, 6)
  balanceBefore Decimal @default(0) @db.Decimal(18, 6)
  balanceAfter  Decimal @default(0) @db.Decimal(18, 6)

  // References
  matchId String?
  betId   String?
  txHash  String?

  description String?
  createdAt   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// PLATFORM
// ============================================

model GlobalStats {
  id             String   @id @default("global")
  liveMatches    Int      @default(0)
  totalMatches   Int      @default(0)
  totalAgents    Int      @default(0)
  totalPrizePool Decimal  @default(0) @db.Decimal(18, 6)
  totalBets      Int      @default(0)
  totalBetVolume Decimal  @default(0) @db.Decimal(18, 6)
  updatedAt      DateTime @updatedAt
}
